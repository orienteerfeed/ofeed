import{a as N,f as U,d as z,_ as K}from"./dateTime-421cc72f.js";import{A as e,i as W,u as Y,e as G,a as J,f as E}from"./useDataProvider-386edcea.js";import{d as w,c as d,o as u,a as c,u as l,t as g,b as v,e as q,x as Q,r as X,g as M,w as Z,F as L,f as B,l as j,a5 as tt,q as et,h as st}from"./index-886848bc.js";import{a as at}from"./CompetitionView-605400e4.js";const nt={class:"grid gap-2 px-3 py-1.5"},lt={key:0,class:"tabular-nums"},ot={key:1,class:"tabular-nums"},rt={key:2},ut={key:3,class:"text-right tabular-nums"},it={key:4,class:"text-right tabular-nums"},ct={key:5,class:"text-right"},dt={class:"text-right tabular-nums"},mt=w({__name:"CategoryRelayTableRowTeam",props:{data:null},setup(a){const t=a,R=d(()=>t.data.latestTotalResult.status===e.Ok?N(t.data.latestTotalResult.timeSeconds):""),k=d(()=>t.data.latestTotalResult.status===e.Ok?`+ ${N(t.data.latestTotalResult.loss)}`:""),S=y=>y.replace(/\s/g,""),f=d(()=>S(t.data.name));return(y,p)=>(u(),c("div",nt,[a.data.status===l(e).Ok&&a.data.latestTotalResult.status===l(e).Ok?(u(),c("span",lt,g(a.data.latestTotalResult.rank)+".",1)):a.data.latestTotalResult.status===l(e).Ok?(u(),c("span",ot,"["+g(a.data.latestTotalResult.rank)+".]",1)):(u(),c("span",rt)),v("span",null,g(l(f))+" - "+g(a.data.club),1),a.data.status===l(e).Ok?(u(),c("span",ut,g(l(R)),1)):a.data.status===l(e).Running&&l(R)?(u(),c("span",it,"["+g(l(R))+"]",1)):(u(),c("span",ct,g(l(U)(a.data.status)),1)),v("span",dt,g(l(k)),1)]))}}),gt=w({__name:"SlotVirtualizer",props:{isVisible:{type:Boolean}},setup(a){return(t,R)=>a.isVisible?q(t.$slots,"default",{key:0}):q(t.$slots,"placeholder",{key:1})}}),ft={class:"grid gap-2 px-3 py-1.5"},ht=v("span",null,null,-1),Rt={key:0,class:"text-right tabular-nums"},Tt={key:1,class:"text-right tabular-nums"},yt={key:2,class:"text-right tabular-nums"},pt={key:3,class:"text-right"},_t={class:"text-right tabular-nums"},vt=w({__name:"CategoryRelayTableRowAthlete",props:{data:null},setup(a){const t=a,R=Q(W,X(!1)),{now:k,timeFormatter:S}=Y(),f=d(()=>t.data.legResult.status===e.Ok?N(t.data.legResult.timeSeconds):""),y=d(()=>t.data.totalResult.status===e.Ok?`+ ${N(t.data.totalResult.loss)}`:""),p=d(()=>G(t.data.legResult)?t.data.startTime?t.data.startTime<k.value:t.data.status===e.Running:!1),x=d(()=>{if(!t.data.startTime||!p.value)return"";const _=z(k.value,t.data.startTime);return N(_)}),T=d(()=>t.data.status===e.NotStarted),C=d(()=>!t.data.startTime||!T.value?"":S.format(t.data.startTime));return(_,$)=>(u(),c("div",ft,[ht,v("span",null,g(a.data.surname)+" "+g(a.data.firstName),1),M(gt,{"is-visible":l(R)},{default:Z(()=>[a.data.legResult.status===l(e).Ok?(u(),c("span",Rt,g(l(f))+" ["+g(a.data.legResult.rank)+".]",1)):l(p)?(u(),c("span",Tt,"["+g(l(x))+"]",1)):l(T)?(u(),c("span",yt,g(l(C)),1)):(u(),c("span",pt,g(l(U)(a.data.status)),1))]),_:1},8,["is-visible"]),v("span",_t,g(l(y)),1)]))}}),kt=v("span",null,null,-1),St=v("span",null,".",-1),xt=[kt,St],bt=w({__name:"CategoryRelayTableRow",props:{data:null,isEven:{type:Boolean},legCount:null},setup(a){const t=a,{now5s:R}=Y(),k=d(()=>t.legCount+1),S=5*60,f=d(()=>t.data.updatedAt?z(R.value,t.data.updatedAt)<S:!1),y=d(()=>f.value?"bg-highlight":t.isEven?"bg-even":"bg-white"),p=d(()=>f.value?"text-white":"text-black"),x=d(()=>{const T=t.legCount-t.data.athletes.length;return T>0?T:0});return(T,C)=>(u(),c("div",{class:tt([[`grid-rows-${l(k)}`,l(y),l(p)],"grid rounded-lg"])},[M(mt,{class:"table-row-grid text-table-large",data:t.data},null,8,["data"]),(u(!0),c(L,null,B(a.data.athletes,_=>(u(),j(vt,{class:"table-row-grid text-table-small",key:_.id,data:_},null,8,["data"]))),128)),(u(!0),c(L,null,B(l(x),_=>(u(),c("div",{key:a.data.id+"-"+_,class:"table-row-grid text-table-small grid gap-2 px-3 py-1.5"},xt))),128))],2))}});function Ct({competition:a,category:t,fetchEnabled:R}){const{key:k,getRelayTeamsLoader:S}=J();if(!S)throw new Error(`Relay loader not available for provider ${k}`);const{relayTeams:f,status:y}=S({category:t,competition:a,fetchEnabled:R}),p=d(()=>{if(y.value!=="success"||!f.value||f.value.length===0)return 0;const s=f.value.map(i=>i.athletes.length);return Math.max(...s)}),x=[e.NotStarted,e.Running,e.Ok,e.DidNotStart,e.OverMaxTime,e.Mispunch,e.Disqualified,e.DidNotFinish,e.NotCompeting],T=d(()=>y.value!=="success"||!f.value?[]:f.value.flatMap(s=>{if(s.athletes.length===0)return[];let n=0,i=0;const o=[...s.athletes].sort((r,h)=>r.leg-h.leg);o.length!==p.value&&(i=x.length-1);const m=o.map((r,h,I)=>{var F;const b=x.findIndex(O=>O===r.status);if(b>i&&(i=b),r.status===e.Running||r.status===e.NotStarted){const O=h!==0&&r.startTime&&r.startTime.getTime()===((F=I[h-1].startTime)==null?void 0:F.getTime())?void 0:r.startTime;return{...r,startTime:O,legResult:{status:r.status},totalResult:{status:r.status}}}return n+=r.timeSeconds,{...r,legResult:{timeSeconds:r.timeSeconds,status:r.status},totalResult:{timeSeconds:n,status:x[i]}}});return[{...s,status:x[i],athletes:m}]})),C=s=>s.length===0?[]:s.reduce((n,i)=>{for(const o of i.athletes)n[o.leg-1].push(o);return n},Array.from({length:p.value},()=>[])),_=(s,n)=>{const i=[];for(const o of s){const m=o[n];E(m)&&i.push(m.timeSeconds)}return i.sort((o,m)=>o-m)},$=s=>s.length===0?[]:s.reduce((n,i,o)=>(n[o].legTimes=_(i,"legResult"),n[o].totalTimes=_(i,"totalResult"),n),Array.from({length:s.length},()=>({legTimes:[],totalTimes:[]}))),A=d(()=>{if(T.value.length===0)return[];const s=$(C(T.value)),n=s.map(o=>o.legTimes[0]),i=s.map(o=>o.totalTimes[0]);return T.value.map(o=>{let m=0;const r=o.athletes.map((h,I)=>{m===I&&h.status!==e.NotStarted&&h.status!==e.Running&&m++;const b=h.leg-1,F=E(h.legResult)?V(h.legResult,s[b].legTimes,n[b]):{...h.legResult},O=E(h.totalResult)?V(h.totalResult,s[b].totalTimes,i[b]):{...h.totalResult};return{...h,legResult:F,totalResult:O}});return{...o,athletes:r,legsDone:m,status:m!==p.value&&o.status===e.Ok?e.Running:o.status,latestTotalResult:r.length?r[m>0?m-1:0].totalResult:{status:e.NotStarted},updatedAt:m>0?r[m-1].updatedAt:void 0}})}),V=(s,n,i)=>{const o=s.timeSeconds,m=n.indexOf(o),r=Ot(i,o);return{...s,rank:m+1,loss:r}},D=d(()=>A.value.length===0?[]:[...A.value].sort((s,n)=>s.status!==n.status?P[s.status]-P[n.status]:s.legsDone!==n.legsDone?n.legsDone-s.legsDone:s.latestTotalResult.status===e.Ok&&n.latestTotalResult.status===e.Ok&&s.latestTotalResult.timeSeconds!==n.latestTotalResult.timeSeconds?s.latestTotalResult.timeSeconds-n.latestTotalResult.timeSeconds:s.name.localeCompare(n.name))),H=d(()=>{const s=D.value.filter(n=>n.status!==e.NotStarted&&n.status!==e.Running);return{full:D.value.length,finished:s.length,unfinished:D.value.length-s.length}});return{status:y,relayTeams:D,teamCounts:H,legCount:p}}const $t=[e.Ok,e.Running,e.NotStarted,e.OverMaxTime,e.NotCompeting,e.DidNotStart,e.DidNotFinish,e.Mispunch,e.Disqualified],P=$t.reduce((a,t,R)=>(a[t]=R,a),{});function Ot(a,t){return t-a}const Nt={class:"w-full text-table-large font-bold bg-white"},wt={key:0,class:"bg-gray-300 h-100"},At=v("span",null,"Loading data",-1),Dt=[At],Bt=w({__name:"CategoryRelayTable",props:{competition:null,category:null},setup(a){const t=a,{scrollItemRef:R,stickyRef:k,contentRef:S,isActive:f}=at(t.category.name),{relayTeams:y,teamCounts:p,status:x,legCount:T}=Ct({competition:t.competition,category:t.category,fetchEnabled:f});return et(W,f),(C,_)=>(u(),c("div",{ref_key:"scrollItemRef",ref:R},[v("div",{class:"sticky top-0",ref_key:"stickyRef",ref:k},[M(K,{class:"p-3",category:t.category,"athletes-count":l(p)},null,8,["category","athletes-count"])],512),v("div",{ref_key:"contentRef",ref:S},[v("div",Nt,[(u(!0),c(L,null,B(l(y),($,A)=>(u(),j(bt,{key:$.id,"is-even":A%2===0,data:$,"leg-count":l(T)},null,8,["is-even","data","leg-count"]))),128))])],512),l(x)!=="success"?(u(),c("div",wt,Dt)):st("",!0)],512))}});export{Bt as default};
